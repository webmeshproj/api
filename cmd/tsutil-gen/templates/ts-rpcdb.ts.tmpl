{{- $typesRoot := .Spec.TypesPath -}}
import { PromiseClient } from "@connectrpc/connect";
import { AppDaemon } from "{{ $typesRoot }}/app_connect.js";
{{ range $file, $types := .Spec.Imports -}}
import { {{ join $types "," }} } from "{{ $typesRoot }}/{{ $file }}.js";
{{ end -}}
import { 
	QueryRequest_QueryCommand,
	QueryRequest_QueryType,
} from "{{ $typesRoot }}/storage_query_pb.js";

{{ range .Spec.Interfaces }}
export class {{ .Name }}s {
	constructor(private readonly client: PromiseClient<AppDaemon>, private readonly connID: string) {}

	get(id: string): Promise<{{ .Name }}> {
		return new Promise((resolve, reject) => {
			this.client.query({
				id: this.connID,
				query: {
					command: QueryRequest_QueryCommand.GET,
					type: QueryRequest_QueryType.{{ .QueryType }},
					query: 'id=' + id,
				}
			}).then((res) => {
				if (res.items.length == 0) {
					reject(new Error("{{ .Name }} not found"))
					return
				}
				resolve({{ .Name }}.fromJson(res.items[0]))
			}).catch((err) => {
				reject(err)
			})
		});
	},

	delete(id: string): Promise<void> {
		return new Promise((resolve, reject) => {
			this.client.query({
				id: this.connID,
				query: {
					command: QueryRequest_QueryCommand.DELETE,
					type: QueryRequest_QueryType.{{ .QueryType }},
					query: 'id=' + id,
				}
			}).then(() => {
				resolve()
			}).catch((err) => {
				reject(err)
			})
		});
	},

	list(): Promise<{{ .Name }}[]> {
		return new Promise((resolve, reject) => {
			this.client.query({
				id: this.connID,
				query: {
					command: QueryRequest_QueryCommand.LIST,
					type: QueryRequest_QueryType.{{ .QueryType }},
				}
			}).then((res) => {
				resolve(res.items.map((item) => {{ .Name }}.fromJson(item)))
			}).catch((err) => {
				reject(err)
			})
		});
	},

	put(obj: {{ .Name }}): Promise<void> {
		return new Promise((resolve, reject) => {
			this.client.query({
				id: this.connID,
				query: {
					command: QueryRequest_QueryCommand.PUT,
					type: QueryRequest_QueryType.{{ .QueryType }},
					item: obj.toJson(),
				}
			}).then(() => {
				resolve()
			}).catch((err) => {
				reject(err)
			})
		});
	}
}
{{- end }}
